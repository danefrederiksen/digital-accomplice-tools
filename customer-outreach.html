<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prospecting Tool #10 — Customers w/ Emails</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Poppins', sans-serif; background: #f5f5f5; color: #1a1a1a; }

/* Header */
.header { background: #000; color: #fff; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
.header h1 { font-size: 20px; font-weight: 700; }
.header h1 span { color: #F8901E; }
.header-right { font-size: 13px; color: #999; }

/* Tabs */
.tabs { background: #fff; border-bottom: 2px solid #eee; padding: 0 24px; display: flex; gap: 0; }
.tab { padding: 12px 20px; cursor: pointer; font-weight: 500; font-size: 14px; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; }
.tab:hover { color: #F8901E; }
.tab.active { color: #F8901E; border-bottom-color: #F8901E; }

/* Content */
.content { max-width: 1100px; margin: 0 auto; padding: 24px; }

/* Alert banner */
.alert-banner { background: linear-gradient(135deg, #F8901E, #e07a10); color: #fff; border-radius: 10px; padding: 16px 20px; margin-bottom: 24px; font-size: 14px; line-height: 1.5; }
.alert-banner strong { font-size: 16px; display: block; margin-bottom: 4px; }
.alert-stat { display: inline-block; background: rgba(255,255,255,0.2); border-radius: 6px; padding: 4px 10px; margin: 4px 4px 4px 0; font-weight: 600; font-size: 13px; }

/* Section headers */
.section-header { font-size: 16px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.section-header .count { background: #F8901E; color: #fff; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; }
.section { margin-bottom: 32px; }

/* Cards */
.card { background: #fff; border-radius: 10px; padding: 16px; margin-bottom: 10px; border: 1px solid #e5e5e5; transition: box-shadow 0.2s; }
.card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.card-name { font-weight: 700; font-size: 15px; }
.card-company { font-size: 13px; color: #666; }
.card-title { font-size: 12px; color: #999; margin-top: 2px; }
.card-meta { display: flex; gap: 12px; font-size: 12px; color: #888; margin-top: 6px; flex-wrap: wrap; align-items: center; }
.card-meta a { color: #F8901E; text-decoration: none; font-weight: 500; }
.card-meta a:hover { text-decoration: underline; }

/* Status badge */
.status { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.status-not_started { background: #e8e8e8; color: #666; }
.status-check_in_sent { background: #fff3e0; color: #e65100; }
.status-follow_up_sent { background: #e3f2fd; color: #1565c0; }
.status-ask_sent { background: #fce4ec; color: #c62828; }
.status-replied { background: #e8f5e9; color: #2e7d32; }
.status-nurture { background: #f3e5f5; color: #6a1b9a; }

/* Buttons */
.btn { padding: 7px 14px; border-radius: 6px; font-family: 'Poppins', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
.btn-primary { background: #F8901E; color: #fff; }
.btn-primary:hover { background: #e07a10; }
.btn-secondary { background: #eee; color: #333; }
.btn-secondary:hover { background: #ddd; }
.btn-danger { background: #fee; color: #c62828; }
.btn-danger:hover { background: #fdd; }
.btn-success { background: #e8f5e9; color: #2e7d32; }
.btn-success:hover { background: #c8e6c9; }
.btn-nurture { background: #f3e5f5; color: #6a1b9a; }
.btn-nurture:hover { background: #e1bee7; }
.btn-sm { padding: 4px 10px; font-size: 11px; }
.btn-group { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }

/* Import */
.import-zone { border: 2px dashed #ccc; border-radius: 10px; padding: 40px; text-align: center; background: #fff; cursor: pointer; transition: border-color 0.2s; margin-bottom: 20px; }
.import-zone:hover { border-color: #F8901E; }
.import-zone input { display: none; }
.import-zone p { color: #888; font-size: 14px; margin-top: 8px; }
.import-zone .icon { font-size: 36px; margin-bottom: 8px; }

/* Filter results table */
.filter-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; border: 1px solid #e5e5e5; }
.filter-table th { background: #fafafa; text-align: left; padding: 10px 12px; font-size: 12px; font-weight: 600; color: #666; border-bottom: 2px solid #eee; }
.filter-table td { padding: 10px 12px; font-size: 13px; border-bottom: 1px solid #f0f0f0; }
.filter-table tr:hover td { background: #fafafa; }
.filter-table input[type="checkbox"] { width: 16px; height: 16px; accent-color: #F8901E; cursor: pointer; }

.selected-count { margin: 12px 0; font-size: 14px; font-weight: 500; }
.selected-count span { color: #F8901E; font-weight: 700; }

/* Reply field */
.reply-area { margin-top: 8px; }
.reply-area textarea { width: 100%; border: 1px solid #ddd; border-radius: 6px; padding: 8px; font-family: 'Poppins', sans-serif; font-size: 13px; resize: vertical; min-height: 60px; }
.reply-area label { font-size: 12px; font-weight: 600; color: #666; display: block; margin-bottom: 4px; }

/* Next step field */
.next-step-field { margin-top: 6px; }
.next-step-field input { width: 100%; border: 1px solid #ddd; border-radius: 6px; padding: 7px 10px; font-family: 'Poppins', sans-serif; font-size: 13px; }

/* Empty state */
.empty { text-align: center; padding: 40px; color: #aaa; font-size: 14px; }
.empty .icon { font-size: 32px; margin-bottom: 8px; }

/* Sequence timeline */
.timeline { display: flex; gap: 0; margin-top: 8px; font-size: 11px; }
.timeline-step { flex: 1; text-align: center; padding: 6px 4px; background: #f5f5f5; border-right: 1px solid #e5e5e5; color: #999; }
.timeline-step:first-child { border-radius: 6px 0 0 6px; }
.timeline-step:last-child { border-radius: 0 6px 6px 0; border-right: none; }
.timeline-step.done { background: #e8f5e9; color: #2e7d32; }
.timeline-step.current { background: #fff3e0; color: #e65100; font-weight: 600; }
.timeline-step.upcoming { background: #f5f5f5; color: #bbb; }

/* Copy message button */
.btn-copy { background: #f0e6ff; color: #6b21a8; }
.btn-copy:hover { background: #e0d0ff; }
.btn-copy.copied { background: #e8f5e9; color: #2e7d32; }
.msg-preview { background: #fafafa; border: 1px solid #eee; border-radius: 6px; padding: 10px 12px; margin-top: 8px; font-size: 12px; color: #555; line-height: 1.5; white-space: pre-wrap; display: none; }
.msg-preview.show { display: block; }

/* Manual add form */
.add-form { background: #fff; border-radius: 10px; padding: 20px; border: 1px solid #e5e5e5; margin-bottom: 20px; }
.add-form h3 { font-size: 14px; margin-bottom: 12px; }
.form-row { display: flex; gap: 10px; margin-bottom: 10px; }
.form-row input { flex: 1; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Poppins', sans-serif; font-size: 13px; }

/* Overdue indicator */
.overdue { color: #c62828; font-weight: 600; font-size: 11px; }

/* Due date info */
.due-info { font-size: 12px; color: #666; margin-top: 4px; }
.due-info strong { color: #F8901E; }

/* LinkedIn URL in card */
.linkedin-link { color: #F8901E; text-decoration: none; font-size: 12px; font-weight: 500; }
.linkedin-link:hover { text-decoration: underline; }

@media (max-width: 700px) {
  .content { padding: 16px; }
  .form-row { flex-direction: column; }
  .card-top { flex-direction: column; gap: 6px; }
}
</style>
</head>
<body>
<div class="header">
  <h1><span>DA</span> Prospecting Tool #10 — Customers w/ Emails</h1>
  <div class="header-right" id="prospect-count"></div>
</div>
<div class="tabs" id="tabs"></div>
<div class="content" id="content"></div>

<script>
// ============================================================
// STATE
// ============================================================
const TITLE_KEYWORDS = [];

let state = {
  prospects: [],
  importedContacts: [],
  activeTab: 'dashboard'
};

// ============================================================
// API HELPERS
// ============================================================
async function apiGet(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`GET ${url} failed: ${res.status}`);
  return res.json();
}

async function apiPost(url, body) {
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error(`POST ${url} failed: ${res.status}`);
  return res.json();
}

async function apiPut(url, body) {
  const res = await fetch(url, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error(`PUT ${url} failed: ${res.status}`);
  return res.json();
}

async function apiDelete(url) {
  const res = await fetch(url, { method: 'DELETE' });
  if (!res.ok) throw new Error(`DELETE ${url} failed: ${res.status}`);
  return res.json();
}

async function loadFromServer() {
  try {
    const data = await apiGet('/api/prospects');
    state.prospects = data.prospects || [];

    // One-time migration: if server is empty but localStorage has data
    if (state.prospects.length === 0) {
      try {
        const local = JSON.parse(localStorage.getItem('da-customer-outreach')) || [];
        if (local.length > 0 && confirm(`Found ${local.length} customers in browser storage. Migrate to server?`)) {
          await apiPost('/api/prospects/migrate', { prospects: local });
          const refreshed = await apiGet('/api/prospects');
          state.prospects = refreshed.prospects || [];
          localStorage.removeItem('da-customer-outreach');
          alert('Migration complete! Your data is now saved on the server.');
        }
      } catch (e) { /* localStorage empty or parse error */ }
    }
  } catch (err) {
    console.error('Failed to load from server:', err);
    // Fallback to localStorage if server is down
    try { state.prospects = JSON.parse(localStorage.getItem('da-customer-outreach')) || []; }
    catch { state.prospects = []; }
  }
  render();
}

// ============================================================
// DATE HELPERS
// ============================================================
function today() {
  const d = new Date();
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

function addDays(dateStr, days) {
  const d = new Date(dateStr);
  d.setDate(d.getDate() + days);
  return d.toISOString().split('T')[0];
}

function daysBetween(dateStr1, dateStr2) {
  const d1 = new Date(dateStr1);
  const d2 = new Date(dateStr2);
  return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function todayStr() {
  return today().toISOString().split('T')[0];
}

// ============================================================
// MESSAGE TEMPLATES
// ============================================================
function firstName(fullName) {
  return (fullName || '').split(' ')[0];
}

function getMessage(prospect, step) {
  const name = firstName(prospect.name);
  const company = prospect.company || 'your team';
  if (step === 'check_in') {
    return {
      subject: `Checking in, ${name}`,
      body: `Hey ${name},\n\nHope things are going well! It's been a while since we worked together and I wanted to check in.\n\nWe've been doing a lot more LinkedIn video content for B2B companies \u2014 short-form thought leadership pieces that are getting solid traction. Thought of you because it'd be a great fit for what ${company} is doing.\n\nWould love to catch up for 15 min if you're open to it.\n\nDane`
    };
  } else if (step === 'value_add') {
    return {
      subject: `Re: Checking in, ${name}`,
      body: `Hey ${name} \u2014 wanted to share something quick. We recently launched a video series on LinkedIn featuring B2B leaders. The format is simple: 15-min conversation, we handle everything, and you get free content tagged to your profile.\n\nHere's what it looks like: https://www.digitalaccomplice.com/video-series\n\nIf you or anyone on your team would be a good fit, I'd love to set it up.\n\nDane`
    };
  } else if (step === 'ask') {
    return {
      subject: `Re: Checking in, ${name}`,
      body: `${name} \u2014 one more thing. If video isn't on the radar right now, totally understand. But if you know anyone who could use help with B2B video content or LinkedIn strategy, I'd really appreciate a referral.\n\nEither way, glad to be in your network.\n\nDane`
    };
  }
  return { subject: '', body: '' };
}

async function copySubject(prospectId, step) {
  const p = state.prospects.find(x => x.id === prospectId);
  if (!p) return;
  const msg = getMessage(p, step);
  try {
    await navigator.clipboard.writeText(msg.subject);
    const btn = document.getElementById('subj-btn-' + prospectId);
    if (btn) {
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'Copy Subject'; btn.classList.remove('copied'); }, 2000);
    }
  } catch (err) { alert('Copy failed \u2014 check browser permissions'); }
}

async function copyBody(prospectId, step) {
  const p = state.prospects.find(x => x.id === prospectId);
  if (!p) return;
  const msg = getMessage(p, step);
  try {
    await navigator.clipboard.writeText(msg.body);
    const btn = document.getElementById('body-btn-' + prospectId);
    if (btn) {
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'Copy Email'; btn.classList.remove('copied'); }, 2000);
    }
  } catch (err) { alert('Copy failed \u2014 check browser permissions'); }
}

function togglePreview(prospectId, step) {
  const el = document.getElementById('msg-preview-' + prospectId);
  if (!el) return;
  if (el.classList.contains('show')) {
    el.classList.remove('show');
  } else {
    const p = state.prospects.find(x => x.id === prospectId);
    if (p) {
      const msg = getMessage(p, step);
      el.textContent = 'Subject: ' + msg.subject + '\n\n' + msg.body;
    }
    el.classList.add('show');
  }
}

// ============================================================
// PROSPECT ACTIONS (async — saved to server)
// ============================================================
async function markCheckInSent(id) {
  const t = todayStr();
  try {
    const updated = await apiPut('/api/prospects/' + id, {
      status: 'check_in_sent',
      emailSentDate: t,
      lastActionDate: t,
      followUp1Due: addDays(t, 7),
      followUp2Due: addDays(t, 17)
    });
    const idx = state.prospects.findIndex(x => x.id === id);
    if (idx !== -1) state.prospects[idx] = updated;
    render();
  } catch (err) { alert('Failed to save: ' + err.message); }
}

async function markFollowUpSent(id) {
  try {
    const updated = await apiPut('/api/prospects/' + id, {
      status: 'follow_up_sent',
      lastActionDate: todayStr()
    });
    const idx = state.prospects.findIndex(x => x.id === id);
    if (idx !== -1) state.prospects[idx] = updated;
    render();
  } catch (err) { alert('Failed to save: ' + err.message); }
}

async function markAskSent(id) {
  try {
    const updated = await apiPut('/api/prospects/' + id, {
      status: 'ask_sent',
      lastActionDate: todayStr()
    });
    const idx = state.prospects.findIndex(x => x.id === id);
    if (idx !== -1) state.prospects[idx] = updated;
    render();
  } catch (err) { alert('Failed to save: ' + err.message); }
}

async function markNurture(id) {
  try {
    const updated = await apiPut('/api/prospects/' + id, {
      status: 'nurture',
      lastActionDate: todayStr()
    });
    const idx = state.prospects.findIndex(x => x.id === id);
    if (idx !== -1) state.prospects[idx] = updated;
    render();
  } catch (err) { alert('Failed to save: ' + err.message); }
}

async function markReplied(id) {
  try {
    const updated = await apiPut('/api/prospects/' + id, {
      status: 'replied',
      lastActionDate: todayStr()
    });
    const idx = state.prospects.findIndex(x => x.id === id);
    if (idx !== -1) state.prospects[idx] = updated;
    render();
  } catch (err) { alert('Failed to save: ' + err.message); }
}

async function reEngage(id) {
  const p = state.prospects.find(x => x.id === id);
  if (!p || !confirm('Re-engage this customer? This will restart the outreach sequence.')) return;
  try {
    const updated = await apiPut('/api/prospects/' + id, {
      status: 'not_started',
      emailSentDate: null,
      followUp1Due: null,
      followUp2Due: null,
      lastActionDate: null
      // NOTE: reply and nextStep are PRESERVED (history matters for customers)
      // NOTE: lastProject, lastProjectDate, customerSince are PRESERVED
    });
    const idx = state.prospects.findIndex(x => x.id === id);
    if (idx !== -1) state.prospects[idx] = updated;
    render();
  } catch (err) { alert('Failed to save: ' + err.message); }
}

const _debounce = {};
function updateReply(id, text) {
  clearTimeout(_debounce['reply_' + id]);
  _debounce['reply_' + id] = setTimeout(async () => {
    try {
      await apiPut('/api/prospects/' + id, { reply: text });
      const p = state.prospects.find(x => x.id === id);
      if (p) p.reply = text;
    } catch (err) { console.error('Failed to save reply:', err); }
  }, 500);
}

function updateNextStep(id, text) {
  clearTimeout(_debounce['next_' + id]);
  _debounce['next_' + id] = setTimeout(async () => {
    try {
      await apiPut('/api/prospects/' + id, { nextStep: text });
      const p = state.prospects.find(x => x.id === id);
      if (p) p.nextStep = text;
    } catch (err) { console.error('Failed to save next step:', err); }
  }, 500);
}

async function removeProspect(id) {
  if (!confirm('Remove this customer?')) return;
  try {
    await apiDelete('/api/prospects/' + id);
    state.prospects = state.prospects.filter(x => x.id !== id);
    render();
  } catch (err) { alert('Failed to remove: ' + err.message); }
}

async function resetProspect(id) {
  const p = state.prospects.find(x => x.id === id);
  if (!p || !confirm('Reset this customer to Not Started? Customer info (last project, customer since) will be preserved.')) return;
  try {
    const updated = await apiPut('/api/prospects/' + id, {
      status: 'not_started',
      emailSentDate: null,
      followUp1Due: null,
      followUp2Due: null,
      lastActionDate: null,
      reply: '',
      nextStep: ''
      // lastProject, lastProjectDate, customerSince are PRESERVED
    });
    const idx = state.prospects.findIndex(x => x.id === id);
    if (idx !== -1) state.prospects[idx] = updated;
    render();
  } catch (err) { alert('Failed to reset: ' + err.message); }
}

// ============================================================
// STATUS LABELS
// ============================================================
const STATUS_LABELS = {
  not_started: 'Not Started',
  check_in_sent: 'Check-In Sent',
  follow_up_sent: 'Value Add Sent',
  ask_sent: 'Ask Sent',
  replied: 'Replied',
  nurture: 'Nurture'
};

// ============================================================
// CSV IMPORT
// ============================================================
function handleCSV(file) {
  Papa.parse(file, {
    header: false,
    skipEmptyLines: true,
    complete: function(results) {
      const raw = results.data;
      if (!raw.length) { alert('CSV appears empty.'); return; }

      const first = raw[0].map(c => (c || '').toLowerCase().trim());
      const hasHeaders = first.includes('email') || first.includes('email address') || first.includes('first name') || first.includes('name');

      let rows;
      if (hasHeaders) {
        const headers = raw[0].map(c => (c || '').trim());
        const dataRows = raw.slice(1);
        rows = dataRows.map(cols => {
          const obj = {};
          headers.forEach((h, i) => { obj[h] = (cols[i] || '').trim(); });
          const fn = obj['First Name'] || obj['first_name'] || obj['Name'] || obj['name'] || '';
          const ln = obj['Last Name'] || obj['last_name'] || '';
          const email = obj['Email'] || obj['email'] || obj['Email Address'] || obj['email_address'] || '';
          const company = obj['Company'] || obj['company'] || obj['Organization'] || '';
          const position = obj['Position'] || obj['position'] || obj['Title'] || obj['title'] || obj['Job Title'] || '';
          const url = obj['URL'] || obj['url'] || obj['LinkedIn URL'] || obj['Profile URL'] || '';
          const source = obj['Source'] || obj['source'] || '';
          const lastProject = obj['Last Project'] || obj['last_project'] || '';
          const lastProjectDate = obj['Last Project Date'] || obj['last_project_date'] || '';
          const customerSince = obj['Customer Since'] || obj['customer_since'] || '';
          return { firstName: fn, lastName: ln, email, company, position, url, source, lastProject, lastProjectDate, customerSince, selected: false };
        });
      } else {
        rows = raw.map(cols => {
          const name = (cols[0] || '').trim();
          let email = '';
          let company = (cols[1] || '').trim();
          let title = (cols[2] || '').trim();
          let url = '';
          for (let i = 0; i < cols.length; i++) {
            if ((cols[i] || '').includes('@')) { email = cols[i].trim(); }
            if ((cols[i] || '').includes('linkedin.com/in/')) { url = cols[i].trim(); }
          }
          if (company.includes('|')) { company = ''; }
          return { firstName: name, lastName: '', email, company, position: title, url, source: '', lastProject: '', lastProjectDate: '', customerSince: '', selected: false };
        });
      }

      // Filter out rows without email
      rows = rows.filter(r => r.email && r.email.includes('@'));
      if (!rows.length) { alert('No contacts with valid email addresses found.'); return; }
      finishImport(rows);
    },
    error: function(err) {
      alert('CSV parse error: ' + err.message);
    }
  });
}

function finishImport(rows) {
  state.importedContacts = rows;
  render();
}

async function activateSelected() {
  const selected = state.importedContacts.filter(c => c.selected);
  if (!selected.length) return;

  const prospects = selected.map(c => ({
    name: (c.firstName + ' ' + c.lastName).trim(),
    company: c.company,
    title: c.position,
    email: c.email,
    linkedinUrl: c.url,
    source: c.source || 'Customer',
    lastProject: c.lastProject,
    lastProjectDate: c.lastProjectDate,
    customerSince: c.customerSince
  }));

  try {
    const result = await apiPost('/api/prospects', { prospects });
    const data = await apiGet('/api/prospects');
    state.prospects = data.prospects || [];
    state.importedContacts = [];
    alert(result.added + ' customer(s) added.' + (result.skipped ? ' ' + result.skipped + ' skipped (duplicates).' : ''));
    state.activeTab = 'dashboard';
    render();
  } catch (err) { alert('Failed to add customers: ' + err.message); }
}

async function addManualProspect() {
  const name = document.getElementById('manual-name').value.trim();
  const email = document.getElementById('manual-email').value.trim();
  const company = document.getElementById('manual-company').value.trim();
  const title = document.getElementById('manual-title').value.trim();
  const lastProject = document.getElementById('manual-project').value.trim();
  const lastProjectDate = document.getElementById('manual-project-date').value.trim();
  const customerSince = document.getElementById('manual-since').value.trim();
  const url = document.getElementById('manual-url').value.trim();

  if (!name) { alert('Name is required.'); return; }
  if (!email || !email.includes('@')) { alert('Valid email is required.'); return; }

  try {
    await apiPost('/api/prospects', { prospects: [{ name, company, title, email, linkedinUrl: url, source: 'Customer', lastProject, lastProjectDate, customerSince }] });
    const data = await apiGet('/api/prospects');
    state.prospects = data.prospects || [];
    document.getElementById('manual-name').value = '';
    document.getElementById('manual-email').value = '';
    document.getElementById('manual-company').value = '';
    document.getElementById('manual-title').value = '';
    document.getElementById('manual-project').value = '';
    document.getElementById('manual-project-date').value = '';
    document.getElementById('manual-since').value = '';
    document.getElementById('manual-url').value = '';
    render();
  } catch (err) { alert('Failed to add customer: ' + err.message); }
}

// ============================================================
// DASHBOARD LOGIC
// ============================================================
function getDmToday() {
  return state.prospects.filter(p => p.status === 'not_started');
}

function getFollowUpToday() {
  const t = todayStr();
  return state.prospects.filter(p => {
    if (p.status === 'check_in_sent' && p.followUp1Due && p.followUp1Due <= t) return true;
    if (p.status === 'follow_up_sent' && p.followUp2Due && p.followUp2Due <= t) return true;
    if (p.status === 'ask_sent' && p.lastActionDate && daysBetween(p.lastActionDate, t) >= 10) return true;
    return false;
  });
}

function getReplied() {
  return state.prospects.filter(p => p.status === 'replied');
}

function getNurture() {
  return state.prospects.filter(p => p.status === 'nurture');
}

function getWaiting() {
  const t = todayStr();
  return state.prospects.filter(p => {
    if (p.status === 'check_in_sent' && p.followUp1Due && p.followUp1Due > t) return true;
    if (p.status === 'follow_up_sent' && p.followUp2Due && p.followUp2Due > t) return true;
    return false;
  });
}

// ============================================================
// RENDER — TABS
// ============================================================
function render() {
  // Prospect count
  document.getElementById('prospect-count').textContent = state.prospects.length + ' customer' + (state.prospects.length !== 1 ? 's' : '');

  // Tabs
  const tabs = [
    { id: 'dashboard', label: 'Dashboard' },
    { id: 'import', label: 'Import' },
    { id: 'prospects', label: 'All Prospects' },
    { id: 'activity', label: 'Activity Log' }
  ];
  document.getElementById('tabs').innerHTML = tabs.map(t =>
    `<div class="tab ${state.activeTab === t.id ? 'active' : ''}" onclick="switchTab('${t.id}')">${t.label}</div>`
  ).join('');

  // Content
  const el = document.getElementById('content');
  if (state.activeTab === 'dashboard') el.innerHTML = renderDashboard();
  else if (state.activeTab === 'import') el.innerHTML = renderImport();
  else if (state.activeTab === 'prospects') el.innerHTML = renderProspects();
  else if (state.activeTab === 'activity') {
    el.innerHTML = '<div class="empty">Loading activity...</div>';
    loadActivityLog();
  }
}

function switchTab(tab) {
  state.activeTab = tab;
  render();
}

// ============================================================
// RENDER — DASHBOARD
// ============================================================
function renderDashboard() {
  const dmList = getDmToday();
  const fuList = getFollowUpToday();
  const reList = getReplied();
  const nurList = getNurture();
  const waitList = getWaiting();

  let html = '';

  // Summary banner
  if (state.prospects.length > 0) {
    html += `<div class="alert-banner">
      <strong>Customer Touchpoints</strong>
      <span class="alert-stat">${dmList.length} check-in${dmList.length !== 1 ? 's' : ''} to send</span>
      <span class="alert-stat">${fuList.length} follow-up${fuList.length !== 1 ? 's' : ''} due</span>
      <span class="alert-stat">${reList.length} repl${reList.length !== 1 ? 'ies' : 'y'} to handle</span>
      <span class="alert-stat">${nurList.length} in nurture</span>
    </div>`;
  }

  // Re-Engage Today (was "Email Today")
  html += `<div class="section">
    <div class="section-header">Re-Engage Today <span class="count">${dmList.length}</span></div>`;
  if (dmList.length === 0) {
    html += `<div class="empty"><div class="icon">&#x2713;</div>No check-ins to send today</div>`;
  } else {
    dmList.forEach(p => {
      html += renderDashboardCard(p, 'checkin');
    });
  }
  html += `</div>`;

  // Follow Up Today
  html += `<div class="section">
    <div class="section-header">Follow Up Today <span class="count">${fuList.length}</span></div>`;
  if (fuList.length === 0) {
    html += `<div class="empty"><div class="icon">&#x2713;</div>No follow-ups due today</div>`;
  } else {
    fuList.forEach(p => {
      html += renderDashboardCard(p, 'followup');
    });
  }
  html += `</div>`;

  // Replied
  html += `<div class="section">
    <div class="section-header">Replied <span class="count">${reList.length}</span></div>`;
  if (reList.length === 0) {
    html += `<div class="empty"><div class="icon">&#x1F4AC;</div>No replies yet</div>`;
  } else {
    reList.forEach(p => {
      html += renderDashboardCard(p, 'replied');
    });
  }
  html += `</div>`;

  // In Nurture
  html += `<div class="section">
    <div class="section-header">In Nurture <span class="count">${nurList.length}</span></div>`;
  if (nurList.length === 0) {
    html += `<div class="empty"><div class="icon">&#x1F331;</div>No customers in nurture</div>`;
  } else {
    nurList.forEach(p => {
      const t = todayStr();
      const daysSince = p.lastActionDate ? daysBetween(p.lastActionDate, t) : 0;
      html += `<div class="card">
        <div class="card-top">
          <div>
            <span class="card-name">${esc(p.name)}</span> <span class="card-company">@ ${esc(p.company)}</span>
            <div class="card-meta">
              <span>${esc(p.email)}</span>
              ${p.lastProject ? `<span style="background:#e3f2fd;padding:2px 8px;border-radius:4px;font-size:11px;color:#1565c0;">Last: ${esc(p.lastProject)}</span>` : ''}
              ${daysSince > 0 ? `<span>${daysSince} day${daysSince !== 1 ? 's' : ''} since last action</span>` : ''}
            </div>
          </div>
          <span class="status status-nurture">${STATUS_LABELS.nurture}</span>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary btn-sm" onclick="reEngage('${p.id}')">Re-Engage</button>
        </div>
      </div>`;
    });
  }
  html += `</div>`;

  // Waiting (check_in_sent and follow_up_sent with future dates)
  if (waitList.length > 0) {
    html += `<div class="section">
      <div class="section-header">Waiting for Response</div>`;
    waitList.forEach(p => {
      let dueLabel = '';
      if (p.status === 'check_in_sent') dueLabel = 'Value add due ' + formatDate(p.followUp1Due);
      else if (p.status === 'follow_up_sent') dueLabel = 'Ask due ' + formatDate(p.followUp2Due);
      html += `<div class="card">
        <div class="card-top">
          <div>
            <span class="card-name">${esc(p.name)}</span> <span class="card-company">@ ${esc(p.company)}</span>
            <div class="card-meta">
              <span>${esc(p.email)}</span>
              ${p.lastProject ? `<span style="background:#e3f2fd;padding:2px 8px;border-radius:4px;font-size:11px;color:#1565c0;">Last: ${esc(p.lastProject)}</span>` : ''}
            </div>
          </div>
          <span class="status status-${p.status}">${STATUS_LABELS[p.status]}</span>
        </div>
        <div class="due-info">${dueLabel}</div>
      </div>`;
    });
    html += `</div>`;
  }

  return html;
}

function renderDashboardCard(p, mode) {
  let buttons = '';
  let extra = '';
  const t = todayStr();

  if (mode === 'checkin') {
    buttons = `
      <button class="btn btn-copy btn-sm" id="subj-btn-${p.id}" onclick="copySubject('${p.id}','check_in')">Copy Subject</button>
      <button class="btn btn-copy btn-sm" id="body-btn-${p.id}" onclick="copyBody('${p.id}','check_in')">Copy Email</button>
      <button class="btn btn-secondary btn-sm" onclick="togglePreview('${p.id}','check_in')">Preview</button>
      <button class="btn btn-primary btn-sm" onclick="markCheckInSent('${p.id}')">Mark Check-In Sent</button>
    `;
    extra = `<div class="msg-preview" id="msg-preview-${p.id}"></div>`;
  } else if (mode === 'followup') {
    if (p.status === 'check_in_sent') {
      const daysOver = daysBetween(p.followUp1Due, t);
      const overdueLabel = daysOver > 0 ? `<span class="overdue">${daysOver} day${daysOver > 1 ? 's' : ''} overdue</span>` : '';
      extra = `<div class="due-info">Value add follow-up ${overdueLabel}</div><div class="msg-preview" id="msg-preview-${p.id}"></div>`;
      buttons = `
        <button class="btn btn-copy btn-sm" id="subj-btn-${p.id}" onclick="copySubject('${p.id}','value_add')">Copy Subject</button>
        <button class="btn btn-copy btn-sm" id="body-btn-${p.id}" onclick="copyBody('${p.id}','value_add')">Copy Email</button>
        <button class="btn btn-secondary btn-sm" onclick="togglePreview('${p.id}','value_add')">Preview</button>
        <button class="btn btn-primary btn-sm" onclick="markFollowUpSent('${p.id}')">Mark Value Add Sent</button>
        <button class="btn btn-success btn-sm" onclick="markReplied('${p.id}')">Got Reply</button>
      `;
    } else if (p.status === 'follow_up_sent') {
      const daysOver = daysBetween(p.followUp2Due, t);
      const overdueLabel = daysOver > 0 ? `<span class="overdue">${daysOver} day${daysOver > 1 ? 's' : ''} overdue</span>` : '';
      extra = `<div class="due-info">Ask follow-up ${overdueLabel}</div><div class="msg-preview" id="msg-preview-${p.id}"></div>`;
      buttons = `
        <button class="btn btn-copy btn-sm" id="subj-btn-${p.id}" onclick="copySubject('${p.id}','ask')">Copy Subject</button>
        <button class="btn btn-copy btn-sm" id="body-btn-${p.id}" onclick="copyBody('${p.id}','ask')">Copy Email</button>
        <button class="btn btn-secondary btn-sm" onclick="togglePreview('${p.id}','ask')">Preview</button>
        <button class="btn btn-primary btn-sm" onclick="markAskSent('${p.id}')">Mark Ask Sent</button>
        <button class="btn btn-success btn-sm" onclick="markReplied('${p.id}')">Got Reply</button>
      `;
    } else if (p.status === 'ask_sent') {
      extra = `<div class="due-info">No reply after ask \u2014 move to nurture?</div>`;
      buttons = `
        <button class="btn btn-nurture btn-sm" onclick="markNurture('${p.id}')">Move to Nurture</button>
        <button class="btn btn-success btn-sm" onclick="markReplied('${p.id}')">Got Reply</button>
      `;
    }
  } else if (mode === 'replied') {
    extra = `
      <div class="reply-area">
        <label>Their reply:</label>
        <textarea placeholder="Paste what they said..." onblur="updateReply('${p.id}', this.value)">${esc(p.reply || '')}</textarea>
      </div>
      <div class="next-step-field">
        <label style="font-size:12px;font-weight:600;color:#666;display:block;margin-bottom:4px;">Next step:</label>
        <input placeholder="e.g. Schedule call for Tuesday" value="${esc(p.nextStep || '')}" onblur="updateNextStep('${p.id}', this.value)" />
      </div>
    `;
  }

  return `<div class="card">
    <div class="card-top">
      <div>
        <span class="card-name">${esc(p.name)}</span> <span class="card-company">@ ${esc(p.company)}</span>
        <div class="card-title">${esc(p.title)}</div>
        <div class="card-meta">
          <span>${esc(p.email)}</span>
          ${p.lastProject ? `<span style="background:#e3f2fd;padding:2px 8px;border-radius:4px;font-size:11px;color:#1565c0;">Last: ${esc(p.lastProject)}</span>` : ''}
          ${p.lastProjectDate ? `<span>${formatDate(p.lastProjectDate)}</span>` : ''}
          ${p.customerSince ? `<span>Customer since ${formatDate(p.customerSince)}</span>` : ''}
          ${p.linkedinUrl ? `<a href="${esc(p.linkedinUrl)}" target="_blank" class="linkedin-link">LinkedIn</a>` : ''}
        </div>
      </div>
      <span class="status status-${p.status}">${STATUS_LABELS[p.status]}</span>
    </div>
    ${extra}
    ${renderTimeline(p)}
    <div class="btn-group">${buttons}</div>
  </div>`;
}

function renderTimeline(p) {
  const steps = [
    { label: 'Check-In', key: 'check_in_sent' },
    { label: 'Value Add', key: 'follow_up_sent' },
    { label: 'Ask', key: 'ask_sent' }
  ];
  const statusOrder = ['not_started', 'check_in_sent', 'follow_up_sent', 'ask_sent'];
  const currentIdx = statusOrder.indexOf(p.status);

  if (p.status === 'not_started' || p.status === 'replied' || p.status === 'nurture') return '';

  return `<div class="timeline">${steps.map((s, i) => {
    const stepIdx = i + 1;
    let cls = 'upcoming';
    if (stepIdx < currentIdx) cls = 'done';
    else if (stepIdx === currentIdx) cls = 'current';
    return `<div class="timeline-step ${cls}">${s.label}</div>`;
  }).join('')}</div>`;
}

// ============================================================
// RENDER — IMPORT
// ============================================================
function renderImport() {
  let html = `
    <div class="import-zone" onclick="document.getElementById('csv-input').click()">
      <div class="icon">&#x1F4C4;</div>
      <strong>Upload Customer CSV</strong>
      <p>CSV should include name and email columns. Optional: Last Project, Customer Since.</p>
      <input type="file" id="csv-input" accept=".csv" onchange="if(this.files[0]){handleCSV(this.files[0]);this.value='';}" />
    </div>
  `;

  // Manual add
  html += `
    <div class="add-form">
      <h3>Or add manually</h3>
      <div class="form-row">
        <input id="manual-name" placeholder="Full name *" />
        <input id="manual-email" placeholder="Email *" />
      </div>
      <div class="form-row">
        <input id="manual-company" placeholder="Company" />
        <input id="manual-title" placeholder="Title" />
      </div>
      <div class="form-row">
        <input id="manual-project" placeholder="Last project (e.g. Brand video, 2024)" />
        <input id="manual-project-date" placeholder="Last project date (YYYY-MM-DD)" />
      </div>
      <div class="form-row">
        <input id="manual-since" placeholder="Customer since (YYYY-MM-DD)" />
        <input id="manual-url" placeholder="LinkedIn URL (optional)" />
      </div>
      <button class="btn btn-primary" onclick="addManualProspect()">Add Customer</button>
    </div>
  `;

  // Imported contacts table
  if (state.importedContacts.length > 0) {
    const selectedCount = state.importedContacts.filter(c => c.selected).length;
    html += `<div class="selected-count">Selected: <span>${selectedCount}</span> of ${state.importedContacts.length}</div>`;
    html += `<table class="filter-table">
      <thead><tr>
        <th></th><th>Name</th><th>Email</th><th>Company</th><th>Last Project</th>
      </tr></thead><tbody>`;

    state.importedContacts.forEach((c, i) => {
      const name = (c.firstName + ' ' + c.lastName).trim();
      html += `<tr>
        <td><input type="checkbox" ${c.selected ? 'checked' : ''} onchange="toggleContact(${i})" /></td>
        <td>${esc(name)}</td>
        <td>${esc(c.email)}</td>
        <td>${esc(c.company)}</td>
        <td>${esc(c.lastProject)}</td>
      </tr>`;
    });

    html += `</tbody></table>`;
    html += `<div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
      <button class="btn btn-primary" onclick="selectAllContacts()">Select All</button>
      <button class="btn btn-primary" onclick="activateSelected()" ${selectedCount === 0 ? 'disabled' : ''}>Activate ${selectedCount} Customer${selectedCount !== 1 ? 's' : ''}</button>
    </div>`;
  }

  return html;
}

function toggleContact(index) {
  state.importedContacts[index].selected = !state.importedContacts[index].selected;
  render();
}

function selectAllContacts() {
  const allSelected = state.importedContacts.every(c => c.selected);
  state.importedContacts.forEach(c => { c.selected = !allSelected; });
  render();
}

// ============================================================
// RENDER — ALL PROSPECTS
// ============================================================
function renderProspects() {
  if (state.prospects.length === 0) {
    return `<div class="empty"><div class="icon">&#x1F465;</div>No customers yet. Import a CSV or add manually.</div>`;
  }

  let html = '';
  const order = ['not_started', 'check_in_sent', 'follow_up_sent', 'ask_sent', 'replied', 'nurture'];
  const sorted = [...state.prospects].sort((a, b) => order.indexOf(a.status) - order.indexOf(b.status));

  sorted.forEach(p => {
    html += `<div class="card">
      <div class="card-top">
        <div>
          <span class="card-name">${esc(p.name)}</span> <span class="card-company">@ ${esc(p.company)}</span>
          <div class="card-title">${esc(p.title)}</div>
          <div class="card-meta">
            <span>${esc(p.email)}</span>
            ${p.lastProject ? `<span style="background:#e3f2fd;padding:2px 8px;border-radius:4px;font-size:11px;color:#1565c0;">Last: ${esc(p.lastProject)}</span>` : ''}
            ${p.lastProjectDate ? `<span>${formatDate(p.lastProjectDate)}</span>` : ''}
            ${p.customerSince ? `<span>Customer since ${formatDate(p.customerSince)}</span>` : ''}
            ${p.linkedinUrl ? `<a href="${esc(p.linkedinUrl)}" target="_blank" class="linkedin-link">LinkedIn</a>` : ''}
            ${p.emailSentDate ? `<span>Check-in: ${formatDate(p.emailSentDate)}</span>` : ''}
            ${p.lastActionDate ? `<span>Last action: ${formatDate(p.lastActionDate)}</span>` : ''}
          </div>
        </div>
        <span class="status status-${p.status}">${STATUS_LABELS[p.status]}</span>
      </div>
      ${renderTimeline(p)}
      ${p.reply ? `<div style="margin-top:8px;font-size:13px;"><strong>Reply:</strong> ${esc(p.reply)}</div>` : ''}
      ${p.nextStep ? `<div style="margin-top:4px;font-size:13px;"><strong>Next:</strong> ${esc(p.nextStep)}</div>` : ''}
      <div class="btn-group">
        ${p.status === 'not_started' ? `<button class="btn btn-primary btn-sm" onclick="markCheckInSent('${p.id}')">Mark Check-In Sent</button>` : ''}
        ${p.status === 'check_in_sent' ? `<button class="btn btn-primary btn-sm" onclick="markFollowUpSent('${p.id}')">Mark Value Add Sent</button>` : ''}
        ${p.status === 'follow_up_sent' ? `<button class="btn btn-primary btn-sm" onclick="markAskSent('${p.id}')">Mark Ask Sent</button>` : ''}
        ${p.status !== 'replied' && p.status !== 'nurture' ? `<button class="btn btn-success btn-sm" onclick="markReplied('${p.id}')">Got Reply</button>` : ''}
        ${p.status !== 'nurture' ? `<button class="btn btn-nurture btn-sm" onclick="markNurture('${p.id}')">Move to Nurture</button>` : ''}
        ${p.status === 'nurture' ? `<button class="btn btn-primary btn-sm" onclick="reEngage('${p.id}')">Re-Engage</button>` : ''}
        <button class="btn btn-secondary btn-sm" onclick="resetProspect('${p.id}')">Reset</button>
        <button class="btn btn-secondary btn-sm" onclick="removeProspect('${p.id}')">Remove</button>
      </div>
    </div>`;
  });

  return html;
}

// ============================================================
// RENDER — ACTIVITY LOG
// ============================================================
async function loadActivityLog() {
  try {
    const data = await apiGet('/api/activity?limit=100');
    const el = document.getElementById('content');
    if (state.activeTab !== 'activity') return;

    if (!data.activity || data.activity.length === 0) {
      el.innerHTML = '<div class="empty"><div class="icon">&#x1F4CB;</div>No activity recorded yet. Actions will appear here as you use the tool.</div>';
      return;
    }

    let html = '<div class="section"><div class="section-header">Activity Log <span class="count">' + data.activity.length + '</span></div>';
    let lastDate = '';
    data.activity.forEach(a => {
      const dateStr = a.date ? a.date.split('T')[0] : '';
      const timeStr = a.date ? new Date(a.date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';
      if (dateStr !== lastDate) {
        lastDate = dateStr;
        html += `<div style="font-size:13px;font-weight:700;color:#333;margin:16px 0 8px;padding-bottom:4px;border-bottom:1px solid #eee;">${formatDate(dateStr)}</div>`;
      }
      html += `<div class="card" style="padding:10px 16px;">
        <span style="font-size:12px;color:#888;min-width:70px;display:inline-block;">${timeStr}</span>
        <span style="font-size:13px;margin-left:8px;"><strong>${esc(a.action)}</strong>${a.prospectName ? ' \u2014 ' + esc(a.prospectName) : ''}</span>
      </div>`;
    });
    html += '</div>';
    el.innerHTML = html;
  } catch (err) {
    document.getElementById('content').innerHTML = '<div class="empty">Failed to load activity log.</div>';
  }
}

// ============================================================
// HELPERS
// ============================================================
function esc(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ============================================================
// INIT
// ============================================================
loadFromServer();
</script>
</body>
</html>