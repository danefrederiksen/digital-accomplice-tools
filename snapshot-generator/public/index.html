<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DA Snapshot Generator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
  /* ===== DA Brand Colors ===== */
  :root {
    --orange: #F38B1C;
    --black: #000000;
    --body: #5A6B7A;
    --gray: #CBCBCB;
    --light: #F5F5F5;
    --white: #FFFFFF;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', Arial, Helvetica, sans-serif; background: #f0f0f0; color: #333; }

  /* ===== App Layout ===== */
  .app { display: flex; height: 100vh; }
  .panel-form { width: 420px; background: var(--white); border-right: 1px solid #ddd; overflow-y: auto; padding: 32px 24px; flex-shrink: 0; }
  .panel-preview { flex: 1; overflow: auto; padding: 32px; display: flex; justify-content: center; align-items: flex-start; background: #e8e8e8; }

  /* ===== Form Styles ===== */
  .panel-form h1 { font-size: 20px; font-weight: 800; color: var(--black); margin-bottom: 4px; }
  .panel-form .subtitle { font-size: 13px; color: var(--body); margin-bottom: 24px; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 12px; font-weight: 700; color: var(--body); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  .form-group input, .form-group textarea, .form-group select {
    width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px;
    font-family: 'Inter', sans-serif; font-size: 14px; color: var(--black); background: var(--white);
  }
  .form-group textarea { resize: vertical; min-height: 60px; }
  .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--orange); }
  .form-group .hint { font-size: 11px; color: var(--gray); margin-top: 4px; }

  .stat-row { display: flex; gap: 12px; }
  .stat-row .form-group { flex: 1; }

  .section-label { font-size: 14px; font-weight: 800; color: var(--orange); text-transform: uppercase; letter-spacing: 1px; margin: 24px 0 12px; border-top: 2px solid var(--light); padding-top: 16px; }

  .btn-row { display: flex; gap: 10px; margin-top: 24px; }
  .btn {
    flex: 1; padding: 12px 16px; border: none; border-radius: 8px; font-family: 'Inter', sans-serif;
    font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.15s;
  }
  .btn-primary { background: var(--orange); color: var(--white); }
  .btn-primary:hover { background: #e07d15; }
  .btn-secondary { background: var(--black); color: var(--white); }
  .btn-secondary:hover { background: #333; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .status { margin-top: 12px; font-size: 13px; color: var(--body); min-height: 20px; }
  .status.success { color: #22c55e; }
  .status.error { color: #ef4444; }

  /* ===== Preview Scale ===== */
  .preview-wrapper {
    transform-origin: top center;
    /* Scale dynamically via JS based on available width */
  }
</style>
</head>
<body>

<div class="app">
  <!-- LEFT: Form -->
  <div class="panel-form">
    <h1>Snapshot Generator</h1>
    <p class="subtitle">Video Opportunity DM Infographic</p>

    <div class="section-label">Company</div>
    <div class="form-group">
      <label>Company Name</label>
      <input type="text" id="companyName" value="BreachRx" oninput="updatePreview()">
    </div>

    <div class="section-label">Headline</div>
    <div class="form-group">
      <label>Line 1 (black text)</label>
      <input type="text" id="headlineLine1" value="You have the experts." oninput="updatePreview()">
      <div class="hint">Pattern: "[Company] has [asset]."</div>
    </div>
    <div class="form-group">
      <label>Line 2 (orange text)</label>
      <input type="text" id="headlineLine2" value="AI search can't find them." oninput="updatePreview()">
      <div class="hint">Pattern: "[Channel] can't find them."</div>
    </div>

    <div class="section-label">3 Stats</div>
    <div class="stat-row">
      <div class="form-group">
        <label>Stat 1 Number</label>
        <input type="text" id="stat1Num" value="0" oninput="updatePreview()">
      </div>
      <div class="form-group">
        <label>Stat 1 Label</label>
        <input type="text" id="stat1Label" value="YouTube videos in 2024" oninput="updatePreview()">
      </div>
    </div>
    <div class="stat-row">
      <div class="form-group">
        <label>Stat 2 Number</label>
        <input type="text" id="stat2Num" value="0/20" oninput="updatePreview()">
      </div>
      <div class="form-group">
        <label>Stat 2 Label</label>
        <input type="text" id="stat2Label" value="LinkedIn posts are video" oninput="updatePreview()">
      </div>
    </div>
    <div class="stat-row">
      <div class="form-group">
        <label>Stat 3 Number</label>
        <input type="text" id="stat3Num" value="2/5" oninput="updatePreview()">
      </div>
      <div class="form-group">
        <label>Stat 3 Label</label>
        <input type="text" id="stat3Label" value="video score vs. competitors" oninput="updatePreview()">
      </div>
    </div>

    <div class="section-label">Bottom Box</div>
    <div class="form-group">
      <label>Main text (white)</label>
      <textarea id="bottomMain" oninput="updatePreview()">No one in breach compliance is producing expert-led video.</textarea>
      <div class="hint">The gap finding. 1 sentence.</div>
    </div>
    <div class="form-group">
      <label>Highlight text (orange)</label>
      <textarea id="bottomHighlight" oninput="updatePreview()">BreachRx has 8 regulatory experts and zero video presence. First mover wins.</textarea>
      <div class="hint">The opportunity + CTA hook.</div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" onclick="exportSnapshot('jpg')">Export JPG</button>
      <button class="btn btn-secondary" onclick="exportSnapshot('html-only')">Save HTML</button>
    </div>
    <div class="status" id="status"></div>
  </div>

  <!-- RIGHT: Live Preview -->
  <div class="panel-preview">
    <div class="preview-wrapper" id="previewWrapper">
      <div id="snapshotPreview"></div>
    </div>
  </div>
</div>

<script>
// ===== Build snapshot HTML with brand CSS baked in =====
function buildSnapshotHTML() {
  const data = {
    companyName: document.getElementById('companyName').value || 'Company',
    headlineLine1: document.getElementById('headlineLine1').value || 'You have the experts.',
    headlineLine2: document.getElementById('headlineLine2').value || "AI search can't find them.",
    stat1Num: document.getElementById('stat1Num').value || '0',
    stat1Label: document.getElementById('stat1Label').value || 'stat label',
    stat2Num: document.getElementById('stat2Num').value || '0',
    stat2Label: document.getElementById('stat2Label').value || 'stat label',
    stat3Num: document.getElementById('stat3Num').value || '0',
    stat3Label: document.getElementById('stat3Label').value || 'stat label',
    bottomMain: document.getElementById('bottomMain').value || '',
    bottomHighlight: document.getElementById('bottomHighlight').value || '',
  };

  return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1080">
<title>Video Opportunity Snapshot — ${esc(data.companyName)}</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
  /* DA Brand — locked */
  :root {
    --orange: #F38B1C;
    --black: #000000;
    --body: #5A6B7A;
    --gray: #CBCBCB;
    --light: #F5F5F5;
    --white: #FFFFFF;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', Arial, Helvetica, sans-serif; background: var(--white); width: 1080px; padding-bottom: 40px; }

  .top-bar {
    background: var(--black); padding: 28px 48px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .top-bar .title {
    font-size: 20px; font-weight: 700; color: var(--orange);
    text-transform: uppercase; letter-spacing: 3px;
  }
  .top-bar .company {
    font-size: 20px; font-weight: 500; color: var(--gray);
  }

  .headline {
    padding: 56px 56px 0 56px;
  }
  .headline h1 {
    font-size: 72px; font-weight: 900; line-height: 1.05; color: var(--black);
    margin: 0;
  }
  .headline h1 .orange { color: var(--orange); }
  .orange-line {
    width: 100px; height: 6px; background: var(--orange);
    margin-top: 32px; border-radius: 3px;
  }

  .stats {
    display: flex; padding: 48px 56px; gap: 0;
    justify-content: space-between; align-items: flex-start;
  }
  .stat { flex: 1; text-align: center; }
  .stat .num {
    font-size: 108px; font-weight: 900; color: var(--orange); line-height: 1;
  }
  .stat .label {
    font-size: 26px; font-weight: 700; color: var(--black); margin-top: 8px;
    line-height: 1.2;
  }
  .stat-divider {
    width: 2px; background: var(--gray); align-self: stretch;
    margin: 0 8px; opacity: 0.5;
  }

  .bottom-box {
    background: var(--black); border-radius: 20px; margin: 0 20px;
    padding: 40px 48px;
  }
  .bottom-box p {
    font-size: 32px; font-weight: 700; color: var(--white); line-height: 1.35;
  }
  .bottom-box p .orange { color: var(--orange); }

  .footer {
    border-top: 3px solid var(--orange);
    margin: 48px 56px 0 56px;
    padding: 28px 0 40px 0;
    display: flex; justify-content: space-between; align-items: center;
  }
  .footer .cta {
    font-size: 24px; font-weight: 700; color: var(--orange);
  }
  .footer .logo {
    display: flex; align-items: center; gap: 12px;
  }
  .footer .logo-icon {
    width: 40px; height: 40px; background: var(--orange); border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
  }
  .footer .logo-icon svg { width: 18px; height: 18px; }
  .footer .logo-text {
    font-size: 16px; font-weight: 700; color: var(--body);
    text-transform: uppercase; letter-spacing: 2px;
  }
</style>
</head>
<body>

<div class="top-bar">
  <span class="title">Video Opportunity Snapshot</span>
  <span class="company">${esc(data.companyName)}</span>
</div>

<div class="headline">
  <h1>${esc(data.headlineLine1)}<br><span class="orange">${esc(data.headlineLine2)}</span></h1>
  <div class="orange-line"></div>
</div>

<div class="stats">
  <div class="stat">
    <div class="num">${esc(data.stat1Num)}</div>
    <div class="label">${esc(data.stat1Label)}</div>
  </div>
  <div class="stat-divider"></div>
  <div class="stat">
    <div class="num">${esc(data.stat2Num)}</div>
    <div class="label">${esc(data.stat2Label)}</div>
  </div>
  <div class="stat-divider"></div>
  <div class="stat">
    <div class="num">${esc(data.stat3Num)}</div>
    <div class="label">${esc(data.stat3Label)}</div>
  </div>
</div>

<div class="bottom-box">
  <p>${esc(data.bottomMain)} <span class="orange">${esc(data.bottomHighlight)}</span></p>
</div>

<div class="footer">
  <span class="cta">Full report attached &#8599;</span>
  <div class="logo">
    <div class="logo-icon">
      <svg viewBox="0 0 24 24" fill="none"><polygon points="8,5 19,12 8,19" fill="white"/></svg>
    </div>
    <span class="logo-text">Digital Accomplice</span>
  </div>
</div>

</body>
</html>`;
}

function esc(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ===== Live Preview =====
function updatePreview() {
  const html = buildSnapshotHTML();
  document.getElementById('snapshotPreview').innerHTML = '';

  const iframe = document.createElement('iframe');
  iframe.style.width = '1080px';
  iframe.style.border = 'none';
  iframe.style.background = 'white';
  iframe.style.display = 'block';
  document.getElementById('snapshotPreview').appendChild(iframe);

  const doc = iframe.contentDocument;
  doc.open();
  doc.write(html);
  doc.close();

  // Auto-size iframe height after content loads
  iframe.onload = () => {
    iframe.style.height = doc.body.scrollHeight + 'px';
    scalePreview();
  };
  // Fallback sizing
  setTimeout(() => {
    iframe.style.height = doc.body.scrollHeight + 'px';
    scalePreview();
  }, 200);
}

function scalePreview() {
  const panel = document.querySelector('.panel-preview');
  const wrapper = document.getElementById('previewWrapper');
  const available = panel.clientWidth - 64; // minus padding
  const scale = Math.min(1, available / 1080);
  wrapper.style.transform = `scale(${scale})`;
}

// ===== Export =====
async function exportSnapshot(format) {
  const statusEl = document.getElementById('status');
  statusEl.className = 'status';
  statusEl.textContent = 'Exporting...';

  try {
    // Get actual content height from the live preview iframe
    const iframe = document.querySelector('#snapshotPreview iframe');
    const contentHeight = iframe ? iframe.contentDocument.body.scrollHeight : 1000;

    const resp = await fetch('/api/export', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        html: buildSnapshotHTML(),
        companyName: document.getElementById('companyName').value || 'Company',
        format: format,
        contentHeight: contentHeight
      })
    });
    const data = await resp.json();
    if (data.success) {
      statusEl.className = 'status success';
      statusEl.textContent = data.message;
    } else {
      statusEl.className = 'status error';
      statusEl.textContent = data.error;
    }
  } catch (err) {
    statusEl.className = 'status error';
    statusEl.textContent = err.message;
  }
}

// Init
window.addEventListener('resize', scalePreview);
updatePreview();
</script>

</body>
</html>
